---
version: '3'

networks:
    kafka-net:
      driver: bridge

services:
    # selenium-tests:
    #     build:
    #       context: .
    #       dockerfile: docker/selenium-tests/Dockerfile
    zookeeper-server:
        image: 'bitnami/zookeeper:latest'
        networks:
        - kafka-net
        ports:
        - '2181:2181'
        environment:
        - ALLOW_ANONYMOUS_LOGIN=yes

    kafka-server:
        image: 'bitnami/kafka:latest'
        networks:
        - kafka-net    
        ports:
        - '9092:9092'
        environment:
        - KAFKA_ZOOKEEPER_CONNECT=zookeeper-server:2181
        - KAFKA_ADVERTISED_HOST_NAME=kafka-server
        - KAFKA_ADVERTISED_PORT=9092
        - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka-server:9092
        - ALLOW_PLAINTEXT_LISTENER=yes
        # - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092
        # - ALLOW_PLAINTEXT_LISTENER=yes
        depends_on:
        - zookeeper-server

    timescaledb:
        build:
          context: .
          dockerfile: docker/timescaledb/Dockerfile
        volumes:
            - ./db-data:/var/lib/postgresql/data
        ports:
            - "5432:5432"
        restart: unless-stopped
    
    pgadmin:
        image: dpage/pgadmin4:4.25
        depends_on: 
            - timescaledb
        environment:
            PGADMIN_DEFAULT_EMAIL: admin@linuxhint.com
            PGADMIN_DEFAULT_PASSWORD: secret
            PGADMIN_LISTEN_PORT: 80
        ports:
            - "8080:80"
        volumes:
            - ./pgadmin-data:/var/lib/pgadmin
        links:
            - "timescaledb:pgsql-server"
        restart: unless-stopped
    
    kafka-alarms:
        build:
            context: .
            dockerfile: docker/kafka-alarms/Dockerfile
        # ports:
        #     - "8080:8080"
        networks:
            - kafka-net
        depends_on:
            - zookeeper-server
            - kafka-server
        environment:
            - KAFKA_CONNECTION_STRING=kafka-server:9092

    kafka-alarms-consumer:
        build:
            context: .
            dockerfile: docker/kafka-alarms/Dockerfile 
        # ports:
        #     - "8080:8080"
        networks:
            - kafka-net
        depends_on:
            - zookeeper-server
            - kafka-server
            - timescaledb
            - kafka-alarms
        environment:
            - HOST=timescaledb
            - PORT=5432
            - DB_NAME=retro_cockpit
            - USER=postgres
            - PASSWORD=password
            - KAFKA_CONNECTION_STRING=kafka-server:9092
        
volumes:
    db-data:
    pgadmin-data: